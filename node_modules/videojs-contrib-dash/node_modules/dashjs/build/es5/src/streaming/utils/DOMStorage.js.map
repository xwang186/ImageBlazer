{"version":3,"sources":["../../../../../src/streaming/utils/DOMStorage.js"],"names":[],"mappings":"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","file":"DOMStorage.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport FactoryMaker from '../../core/FactoryMaker';\nimport Debug from '../../core/Debug';\nimport Constants from '../constants/Constants';\n\nconst legacyKeysAndReplacements = [\n    { oldKey: 'dashjs_vbitrate',  newKey: 'dashjs_video_bitrate' },\n    { oldKey: 'dashjs_abitrate',  newKey: 'dashjs_audio_bitrate' },\n    { oldKey: 'dashjs_vsettings', newKey: 'dashjs_video_settings' },\n    { oldKey: 'dashjs_asettings', newKey: 'dashjs_audio_settings' }\n];\n\nconst LOCAL_STORAGE_BITRATE_KEY_TEMPLATE = 'dashjs_?_bitrate';\nconst LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE = 'dashjs_?_settings';\n\nconst STORAGE_TYPE_LOCAL = 'localStorage';\nconst STORAGE_TYPE_SESSION = 'sessionStorage';\nconst LAST_BITRATE = 'LastBitrate';\nconst LAST_MEDIA_SETTINGS = 'LastMediaSettings';\n\nfunction DOMStorage(config) {\n\n    config = config || {};\n    const context = this.context;\n    const mediaPlayerModel = config.mediaPlayerModel;\n\n    let instance,\n        logger,\n        supported;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n        translateLegacyKeys();\n    }\n\n    //type can be local, session\n    function isSupported(type) {\n        if (supported !== undefined) return supported;\n\n        supported = false;\n\n        const testKey = '1';\n        const testValue = '1';\n        let storage;\n\n        try {\n            if (typeof window !== 'undefined') {\n                storage = window[type];\n            }\n        } catch (error) {\n            logger.warn('DOMStorage access denied: ' + error.message);\n            return supported;\n        }\n\n        if (!storage || (type !== STORAGE_TYPE_LOCAL && type !== STORAGE_TYPE_SESSION)) {\n            return supported;\n        }\n\n        /* When Safari (OS X or iOS) is in private browsing mode, it appears as though localStorage is available, but trying to call setItem throws an exception.\n         http://stackoverflow.com/questions/14555347/html5-localstorage-error-with-safari-quota-exceeded-err-dom-exception-22-an\n\n         Check if the storage can be used\n         */\n        try {\n            storage.setItem(testKey, testValue);\n            storage.removeItem(testKey);\n            supported = true;\n        } catch (error) {\n            logger.warn('DOMStorage is supported, but cannot be used: ' + error.message);\n        }\n\n        return supported;\n    }\n\n    function translateLegacyKeys() {\n        if (isSupported(STORAGE_TYPE_LOCAL)) {\n            legacyKeysAndReplacements.forEach(entry => {\n                const value = localStorage.getItem(entry.oldKey);\n\n                if (value) {\n                    localStorage.removeItem(entry.oldKey);\n\n                    try {\n                        localStorage.setItem(entry.newKey, value);\n                    } catch (e) {\n                        logger.error(e.message);\n                    }\n                }\n            });\n        }\n    }\n\n    // Return current epoch time, ms, rounded to the nearest 10m to avoid fingerprinting user\n    function getTimestamp() {\n        const ten_minutes_ms = 60 * 1000 * 10;\n        return Math.round(new Date().getTime() / ten_minutes_ms) * ten_minutes_ms;\n    }\n\n    function canStore(storageType, key) {\n        return isSupported(storageType) && mediaPlayerModel['get' + key + 'CachingInfo']().enabled;\n    }\n\n    function checkConfig() {\n        if (!mediaPlayerModel || !mediaPlayerModel.hasOwnProperty('getLastMediaSettingsCachingInfo')) {\n            throw new Error(Constants.MISSING_CONFIG_ERROR);\n        }\n    }\n\n    function getSavedMediaSettings(type) {\n        checkConfig();\n        //Checks local storage to see if there is valid, non-expired media settings\n        if (!canStore(STORAGE_TYPE_LOCAL, LAST_MEDIA_SETTINGS)) return null;\n\n        let settings = null;\n        const key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\n        try {\n            const obj = JSON.parse(localStorage.getItem(key)) || {};\n            const isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= mediaPlayerModel.getLastMediaSettingsCachingInfo().ttl || false;\n            settings = obj.settings;\n\n            if (isExpired) {\n                localStorage.removeItem(key);\n                settings = null;\n            }\n        } catch (e) {\n            return null;\n        }\n        return settings;\n    }\n\n    function getSavedBitrateSettings(type) {\n        let savedBitrate = NaN;\n\n        checkConfig();\n\n        //Checks local storage to see if there is valid, non-expired bit rate\n        //hinting from the last play session to use as a starting bit rate.\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_BITRATE)) {\n            const key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                const obj = JSON.parse(localStorage.getItem(key)) || {};\n                const isExpired = (new Date().getTime() - parseInt(obj.timestamp, 10)) >= mediaPlayerModel.getLastMediaSettingsCachingInfo().ttl || false;\n                const bitrate = parseFloat(obj.bitrate);\n\n                if (!isNaN(bitrate) && !isExpired) {\n                    savedBitrate = bitrate;\n                    logger.debug('Last saved bitrate for ' + type + ' was ' + bitrate);\n                } else if (isExpired) {\n                    localStorage.removeItem(key);\n                }\n            } catch (e) {\n                return null;\n            }\n        }\n        return savedBitrate;\n    }\n\n    function setSavedMediaSettings(type, value) {\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_MEDIA_SETTINGS)) {\n            const key = LOCAL_STORAGE_SETTINGS_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                localStorage.setItem(key, JSON.stringify({settings: value, timestamp: getTimestamp()}));\n            } catch (e) {\n                logger.error(e.message);\n            }\n        }\n    }\n\n    function setSavedBitrateSettings(type, bitrate) {\n        if (canStore(STORAGE_TYPE_LOCAL, LAST_BITRATE) && bitrate) {\n            const key = LOCAL_STORAGE_BITRATE_KEY_TEMPLATE.replace(/\\?/, type);\n            try {\n                localStorage.setItem(key, JSON.stringify({bitrate: bitrate.toFixed(3), timestamp: getTimestamp()}));\n            } catch (e) {\n                logger.error(e.message);\n            }\n        }\n    }\n\n    instance = {\n        getSavedBitrateSettings: getSavedBitrateSettings,\n        setSavedBitrateSettings: setSavedBitrateSettings,\n        getSavedMediaSettings: getSavedMediaSettings,\n        setSavedMediaSettings: setSavedMediaSettings\n    };\n\n    setup();\n    return instance;\n}\n\nDOMStorage.__dashjs_factory_name = 'DOMStorage';\nconst factory = FactoryMaker.getSingletonFactory(DOMStorage);\nexport default factory;\n"]}